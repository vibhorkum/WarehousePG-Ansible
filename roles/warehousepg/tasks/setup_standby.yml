---
# Standby Coordinator Setup Tasks

- name: Ensure SSH keys are exchanged between coordinator and standby
  become: yes
  become_user: "{{ whpg_gpadmin_user }}"
  authorized_key:
    user: "{{ whpg_gpadmin_user }}"
    state: present
    key: "{{ lookup('file', whpg_gpadmin_home + '/.ssh/id_rsa.pub') }}"

- name: Test SSH connectivity to upstream coordinator
  become: yes
  become_user: "{{ whpg_gpadmin_user }}"
  command: ssh -o StrictHostKeyChecking=no -o BatchMode=yes {{ hostvars[inventory_hostname].upstream_node_private_ip }} uptime
  register: ssh_upstream_test
  changed_when: false
  failed_when: false
  when: hostvars[inventory_hostname].upstream_node_private_ip is defined

- name: Display upstream SSH test result
  debug:
    msg: "SSH to upstream {{ 'succeeded' if ssh_upstream_test.rc == 0 else 'failed' }}"
  when: ssh_upstream_test is defined

- name: Create standby data directory
  become: yes
  become_user: "{{ whpg_gpadmin_user }}"
  file:
    path: "{{ whpg_standby_directory }}"
    state: directory
    owner: "{{ whpg_gpadmin_user }}"
    group: "{{ whpg_gpadmin_user }}"
    mode: '0700'
  when: "'standby-coordinator' in group_names"

- name: Check if standby is already initialized
  stat:
    path: "{{ whpg_standby_directory }}/PG_VERSION"
  register: standby_initialized
  when: "'standby-coordinator' in group_names"

- name: Initialize standby coordinator
  become: yes
  become_user: "{{ whpg_gpadmin_user }}"
  shell: |
    source {{ whpg_install_path }}/greenplum_path.sh
    gpinitstandby -s {{ hostvars[inventory_hostname].private_ip }} -P {{ whpg_standby_port }} -S {{ whpg_standby_directory }} -a
  args:
    executable: /bin/bash
  environment:
    COORDINATOR_DATA_DIRECTORY: "{{ whpg_coordinator_data_directory }}"
  register: standby_init
  when: 
    - "'standby-coordinator' in group_names"
    - not standby_initialized.stat.exists
  delegate_to: "{{ groups['primary-coordinator'][0] }}"

- name: Display standby initialization result
  debug:
    msg: "{{ standby_init.stdout_lines }}"
  when: 
    - standby_init is defined 
    - standby_init.changed

- name: Verify standby replication status
  become: yes
  become_user: "{{ whpg_gpadmin_user }}"
  shell: |
    source {{ whpg_install_path }}/greenplum_path.sh
    psql -p {{ whpg_coordinator_port }} -d postgres -c "SELECT application_name, state, sync_state FROM pg_stat_replication;"
  args:
    executable: /bin/bash
  environment:
    COORDINATOR_DATA_DIRECTORY: "{{ whpg_coordinator_data_directory }}"
  register: replication_status
  changed_when: false
  when: "'primary-coordinator' in group_names"
  delegate_to: "{{ groups['primary-coordinator'][0] }}"

- name: Display replication status
  debug:
    msg: "{{ replication_status.stdout_lines }}"
  when: 
    - replication_status is defined
    - replication_status.stdout_lines is defined
