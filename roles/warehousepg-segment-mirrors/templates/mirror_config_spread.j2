# Mirror Configuration for WarehousePG - Spread Mode
# Generated by Ansible at {{ ansible_date_time.iso8601 }}
#
# Format: content_id|address|port|data_directory
# Mode: spread - mirrors distributed across segment hosts
#       Host A's primaries mirror to Host B
#       Host B's primaries mirror to Host C
#       Host N's primaries mirror to Host A (wrap around)
#
{% set primary_segments_list = groups['whpg_primary_segments'] | default([]) %}
{% set num_hosts = primary_segments_list | length %}
{% set num_segments_per_host = whpg_data_directories | length %}
{% for segment_host_idx in range(num_hosts) %}
{#   Calculate next host in rotation for spread mode #}
{%   set mirror_host_idx = (segment_host_idx + 1) % num_hosts %}
{%   set mirror_host = primary_segments_list[mirror_host_idx] %}
{%   set mirror_host_alias = hostvars[mirror_host].replication_alias | default(mirror_host) %}
{%   for seg_idx in range(num_segments_per_host) %}
{%     set content_id = (segment_host_idx * num_segments_per_host) + seg_idx %}
{%     set mirror_port = whpg_mirror_port_base + seg_idx %}
{%     set mirror_data_dir = whpg_mirror_data_directories[seg_idx] %}
{{ content_id }}|{{ mirror_host_alias }}|{{ mirror_port }}|{{ mirror_data_dir }}
{%   endfor %}
{% endfor %}
