# Mirror Configuration for WarehousePG DR Site
# Generated by Ansible for {{ ansible_date_time.iso8601 }}
#
# Format: content_id|address|port|data_directory
# This file maps primary segments to their DR site mirrors

{% set primary_segments_list = groups['whpg_primary_segments'] | default([]) %}
{% set dr_segments_list = groups['whpg_dr_segments'] | default([]) %}
{% set num_segments_per_host = whpg_data_directories | default(['/data/primary/seg1', '/data/primary/seg2']) | length %}

{% for segment_host_idx in range(primary_segments_list | length) %}
{%   set dr_segment_host = dr_segments_list[segment_host_idx] %}
{%   set dr_segment_repl_alias = hostvars[dr_segment_host].replication_alias | default(dr_segment_host) %}
{%   set dr_segment_private_ip = hostvars[dr_segment_host].private_ip | default(hostvars[dr_segment_host].ansible_host) %}
{%   for seg_idx in range(num_segments_per_host) %}
{%     set content_id = (segment_host_idx * num_segments_per_host) + seg_idx %}
{%     set mirror_port = whpg_mirror_port_base + seg_idx %}
{%     set mirror_data_dir = whpg_mirror_data_directories[seg_idx] if whpg_mirror_data_directories is defined else '/data/mirror/seg' ~ (seg_idx + 1) %}
{{ content_id }}|{{ dr_segment_repl_alias }}|{{ mirror_port }}|{{ mirror_data_dir }}
{%   endfor %}
{% endfor %}
