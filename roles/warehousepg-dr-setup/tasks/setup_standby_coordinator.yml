---
# Setup Standby Coordinator on DR Site

- name: Get DR coordinator host information
  set_fact:
    dr_coordinator_host: "{{ groups['whpg_dr_coordinator'][0] }}"
    dr_coordinator_repl_alias: "{{ hostvars[groups['whpg_dr_coordinator'][0]].replication_alias | default(groups['whpg_dr_coordinator'][0]) }}"
    dr_coordinator_ip: "{{ hostvars[groups['whpg_dr_coordinator'][0]].private_ip | default(hostvars[groups['whpg_dr_coordinator'][0]].ansible_host) }}"
    primary_coordinator_repl_alias: "{{ hostvars[groups['whpg_primary_coordinator'][0]].replication_alias | default(groups['whpg_primary_coordinator'][0]) }}"
  run_once: true

- name: Display standby coordinator setup information
  debug:
    msg:
      - "Setting up standby coordinator on DR site"
      - "Primary Coordinator Replication Alias: {{ primary_coordinator_repl_alias }}"
      - "DR Coordinator IP: {{ dr_coordinator_ip }}"
      - "DR Coordinator Replication Alias: {{ dr_coordinator_repl_alias }}"
      - "Standby Data Directory: {{ whpg_standby_data_directory }}"
      - "Standby Port: {{ whpg_standby_coordinator_port }}"
  run_once: true

- name: Check if standby coordinator already exists
  become: yes
  become_user: gpadmin
  shell: |
    source {{ whpg_base_dir }}/greenplum_path.sh
    export COORDINATOR_DATA_DIRECTORY={{ whpg_coordinator_data_directory | default('/data/coordinator/gpseg-1') }}
    gpstate -f 2>&1
  delegate_to: "{{ groups['whpg_primary_coordinator'][0] }}"
  register: standby_check
  changed_when: false

- name: Set standby configured fact
  set_fact:
    standby_already_configured: "{{ 'not configured' not in standby_check.stdout.lower() and 'standby address' in standby_check.stdout.lower() }}"
  run_once: true

- name: Display standby check result
  debug:
    msg: "Standby already configured: {{ standby_already_configured }}"
  run_once: true

- name: Initialize standby coordinator using replication alias
  become: yes
  become_user: gpadmin
  shell: |
    source {{ whpg_base_dir }}/greenplum_path.sh
    export COORDINATOR_DATA_DIRECTORY={{ whpg_coordinator_data_directory | default('/data/coordinator/gpseg-1') }}
    gpinitstandby -s {{ dr_coordinator_repl_alias }} \
      -S {{ whpg_standby_data_directory }} \
      -a
  delegate_to: "{{ groups['whpg_primary_coordinator'][0] }}"
  register: standby_init
  when: not standby_already_configured
  failed_when:
    - standby_init.rc != 0
    - "'already configured' not in standby_init.stderr"

- name: Display standby initialization result
  debug:
    msg: "{{ standby_init.stdout_lines if standby_init.changed else 'Standby coordinator already configured' }}"

- name: Wait for standby synchronization to start
  pause:
    seconds: 10
  when: standby_init.changed

- name: Verify standby coordinator status
  become: yes
  become_user: gpadmin
  shell: |
    source {{ whpg_base_dir }}/greenplum_path.sh
    export COORDINATOR_DATA_DIRECTORY={{ whpg_coordinator_data_directory | default('/data/coordinator/gpseg-1') }}
    gpstate -f
  delegate_to: "{{ groups['whpg_primary_coordinator'][0] }}"
  register: standby_status
  changed_when: false

- name: Display standby status
  debug:
    var: standby_status.stdout_lines
