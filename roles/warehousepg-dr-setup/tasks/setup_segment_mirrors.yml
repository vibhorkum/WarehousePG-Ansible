---
# Setup Segment Mirrors on DR Site

- name: Create mirror configuration directory
  become: yes
  become_user: gpadmin
  file:
    path: "{{ whpg_admin_home_dir }}/gpconfigs"
    state: directory
    owner: gpadmin
    group: gpadmin
    mode: '0755'
  delegate_to: "{{ groups['whpg_primary_coordinator'][0] }}"

- name: Generate mirror configuration file
  become: yes
  become_user: gpadmin
  template:
    src: mirror_config.j2
    dest: "{{ whpg_admin_home_dir }}/gpconfigs/mirror_config"
    owner: gpadmin
    group: gpadmin
    mode: '0644'
  delegate_to: "{{ groups['whpg_primary_coordinator'][0] }}"

- name: Display mirror configuration
  become: yes
  become_user: gpadmin
  shell: cat "{{ whpg_admin_home_dir }}/gpconfigs/mirror_config"
  delegate_to: "{{ groups['whpg_primary_coordinator'][0] }}"
  register: mirror_config_content
  changed_when: false

- name: Show mirror configuration
  debug:
    var: mirror_config_content.stdout_lines

- name: Check if mirrors already exist
  become: yes
  become_user: gpadmin
  shell: |
    source {{ whpg_base_dir }}/greenplum_path.sh
    export COORDINATOR_DATA_DIRECTORY={{ whpg_coordinator_data_directory | default('/data/coordinator/gpseg-1') }}
    psql -d template1 -t -c "SELECT count(*) FROM gp_segment_configuration WHERE role='m';"
  delegate_to: "{{ groups['whpg_primary_coordinator'][0] }}"
  register: mirror_count
  changed_when: false

- name: Add segment mirrors
  become: yes
  become_user: gpadmin
  shell: |
    source {{ whpg_base_dir }}/greenplum_path.sh
    export COORDINATOR_DATA_DIRECTORY={{ whpg_coordinator_data_directory | default('/data/coordinator/gpseg-1') }}
    gpaddmirrors -i {{ whpg_admin_home_dir }}/gpconfigs/mirror_config -a
  delegate_to: "{{ groups['whpg_primary_coordinator'][0] }}"
  register: add_mirrors
  when: mirror_count.stdout | trim | int == 0
  failed_when:
    - add_mirrors.rc != 0
    - "'already configured' not in add_mirrors.stderr"

- name: Display mirror setup result
  debug:
    msg: "{{ add_mirrors.stdout_lines if add_mirrors.changed else 'Mirrors already configured' }}"

- name: Check if mirrors need recovery
  become: yes
  become_user: gpadmin
  shell: |
    source {{ whpg_base_dir }}/greenplum_path.sh
    export COORDINATOR_DATA_DIRECTORY={{ whpg_coordinator_data_directory | default('/data/coordinator/gpseg-1') }}
    gpstate -e | grep -c "Down" || echo "0"
  delegate_to: "{{ groups['whpg_primary_coordinator'][0] }}"
  register: mirrors_down_count
  changed_when: false
  failed_when: false

# Check if mirror data directories exist on DR segment
# If they don't exist, we need full recovery even if mirrors are already in catalog
- name: Check if mirror data directories exist
  become: yes
  become_user: gpadmin
  stat:
    path: "{{ whpg_mirror_data_directories[0] | default('/data/mirror/seg1') }}/global/pg_control"
  delegate_to: "{{ groups['whpg_dr_segments'][0] }}"
  register: mirror_dir_check
  failed_when: false

- name: Determine recovery type needed
  set_fact:
    needs_full_recovery: "{{ add_mirrors.changed or not mirror_dir_check.stat.exists | default(false) }}"

- name: Debug recovery type decision
  debug:
    msg:
      - "Mirrors added this run: {{ add_mirrors.changed }}"
      - "Mirror pg_control exists: {{ mirror_dir_check.stat.exists | default(false) }}"
      - "Needs full recovery: {{ needs_full_recovery }}"
      - "Mirrors down count: {{ mirrors_down_count.stdout | trim }}"

- name: Recover and sync mirrors (full recovery for new/uninitialized mirrors)
  become: yes
  become_user: gpadmin
  shell: |
    source {{ whpg_base_dir }}/greenplum_path.sh
    export COORDINATOR_DATA_DIRECTORY={{ whpg_coordinator_data_directory | default('/data/coordinator/gpseg-1') }}
    gprecoverseg -aF
  delegate_to: "{{ groups['whpg_primary_coordinator'][0] }}"
  register: recover_mirrors_full
  when: 
    - needs_full_recovery
    - mirrors_down_count.stdout | trim | int > 0
  failed_when:
    - recover_mirrors_full.rc != 0
    - "'No segments to recover' not in recover_mirrors_full.stdout"

- name: Recover and sync mirrors (incremental for existing initialized mirrors)
  become: yes
  become_user: gpadmin
  shell: |
    source {{ whpg_base_dir }}/greenplum_path.sh
    export COORDINATOR_DATA_DIRECTORY={{ whpg_coordinator_data_directory | default('/data/coordinator/gpseg-1') }}
    gprecoverseg -a
  delegate_to: "{{ groups['whpg_primary_coordinator'][0] }}"
  register: recover_mirrors_inc
  when:
    - not needs_full_recovery
    - mirrors_down_count.stdout | trim | int > 0
  failed_when:
    - recover_mirrors_inc.rc != 0
    - "'No segments to recover' not in recover_mirrors_inc.stdout"

- name: Display mirror recovery result
  debug:
    var: "{{ recover_mirrors_full.stdout_lines if recover_mirrors_full is defined and recover_mirrors_full.changed else (recover_mirrors_inc.stdout_lines if recover_mirrors_inc is defined and recover_mirrors_inc.changed else 'No mirrors needed recovery') }}"
  when: mirrors_down_count.stdout | trim | int > 0

- name: Wait for mirror synchronization to start
  pause:
    seconds: 30
  when: mirrors_down_count.stdout | trim | int > 0

- name: Verify mirrors are in sync
  become: yes
  become_user: gpadmin
  shell: |
    source {{ whpg_base_dir }}/greenplum_path.sh
    export COORDINATOR_DATA_DIRECTORY={{ whpg_coordinator_data_directory | default('/data/coordinator/gpseg-1') }}
    gpstate -m
  delegate_to: "{{ groups['whpg_primary_coordinator'][0] }}"
  register: mirror_status
  changed_when: false

- name: Display mirror status
  debug:
    var: mirror_status.stdout_lines
