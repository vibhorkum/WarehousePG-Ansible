---
# Cleanup Tasks for OS Configuration

- name: Restore SELinux to enforcing
  become: yes
  selinux:
    state: enforcing
    policy: targeted
  when:
    - whpg_cleanup_mode | bool
    - whpg_cleanup_restore_defaults | bool

- name: Enable and start firewalld
  become: yes
  systemd:
    name: firewalld
    state: started
    enabled: yes
  when:
    - whpg_cleanup_mode | bool
    - whpg_cleanup_restore_defaults | bool

- name: Remove custom sysctl parameters
  become: yes
  sysctl:
    name: "{{ item }}"
    state: absent
    sysctl_file: /etc/sysctl.conf
    reload: yes
  loop:
    - kernel.shmall
    - kernel.shmmax
    - kernel.shmmni
    - kernel.sem
    - kernel.msgmnb
    - kernel.msgmax
    - kernel.msgmni
    - vm.overcommit_memory
    - vm.overcommit_ratio
    - vm.min_free_kbytes
    - vm.swappiness
    - net.ipv4.ip_local_port_range
    - net.ipv4.ip_local_reserved_ports
    - net.ipv4.tcp_syncookies
    - net.ipv4.tcp_max_syn_backlog
    - net.ipv4.conf.all.arp_filter
    - net.core.netdev_max_backlog
    - net.core.rmem_max
    - net.core.wmem_max
    - net.ipv4.ipfrag_high_thresh
    - net.ipv4.ipfrag_low_thresh
    - net.ipv4.ipfrag_time
  when:
    - whpg_cleanup_mode | bool
    - whpg_cleanup_restore_defaults | bool
  ignore_errors: yes

- name: Remove custom limits for gpadmin
  become: yes
  pam_limits:
    domain: gpadmin
    limit_type: '-'
    limit_item: "{{ item }}"
    dest: /etc/security/limits.conf
    state: absent
  loop:
    - nofile
    - nproc
  when:
    - whpg_cleanup_mode | bool
    - whpg_cleanup_restore_defaults | bool
  ignore_errors: yes

- name: Remove custom limits configuration file
  become: yes
  file:
    path: /etc/security/limits.d/99-warehousepg.conf
    state: absent
  when:
    - whpg_cleanup_mode | bool
    - whpg_cleanup_restore_defaults | bool

- name: Re-enable Transparent Huge Pages
  become: yes
  shell: |
    echo 'always' > /sys/kernel/mm/transparent_hugepage/enabled
    echo 'always' > /sys/kernel/mm/transparent_hugepage/defrag
  args:
    executable: /bin/bash
  changed_when: true
  when:
    - whpg_cleanup_mode | bool
    - whpg_cleanup_restore_defaults | bool
  ignore_errors: yes

- name: Remove THP disable from GRUB
  become: yes
  lineinfile:
    path: /etc/default/grub
    regexp: 'transparent_hugepage='
    state: absent
  when:
    - whpg_cleanup_mode | bool
    - whpg_cleanup_restore_defaults | bool

- name: Update GRUB configuration
  become: yes
  command: grub2-mkconfig -o /boot/grub2/grub.cfg
  changed_when: true
  when:
    - whpg_cleanup_mode | bool
    - whpg_cleanup_restore_defaults | bool
  ignore_errors: yes

- name: Restore default I/O scheduler
  become: yes
  shell: echo 'mq-deadline' > /sys/block/{{ item }}/queue/scheduler
  args:
    executable: /bin/bash
  changed_when: true
  loop: "{{ ansible_devices.keys() | list }}"
  when:
    - whpg_cleanup_mode | bool
    - whpg_cleanup_restore_defaults | bool
    - item not in ['loop0', 'loop1', 'sr0']
  ignore_errors: yes

- name: Remove NTP/Chrony packages if installed by this role
  become: yes
  dnf:
    name:
      - chrony
      - ntp
    state: absent
  when:
    - whpg_cleanup_mode | bool
    - whpg_cleanup_remove_packages | default(false) | bool
  ignore_errors: yes

- name: Restore original chrony configuration if backup exists
  become: yes
  copy:
    src: /etc/chrony.conf.whpg_backup
    dest: /etc/chrony.conf
    remote_src: yes
  when:
    - whpg_cleanup_mode | bool
    - whpg_cleanup_restore_defaults | bool
  ignore_errors: yes

- name: Restore original ntp configuration if backup exists
  become: yes
  copy:
    src: /etc/ntp.conf.whpg_backup
    dest: /etc/ntp.conf
    remote_src: yes
  when:
    - whpg_cleanup_mode | bool
    - whpg_cleanup_restore_defaults | bool
  ignore_errors: yes

- name: Remove configuration backups
  become: yes
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/chrony.conf.whpg_backup
    - /etc/ntp.conf.whpg_backup
    - /etc/sysctl.conf.whpg_backup
  when:
    - whpg_cleanup_mode | bool
    - whpg_cleanup_restore_defaults | bool

- name: Display OS cleanup completion
  debug:
    msg:
      - "OS configuration cleanup completed"
      - "Settings restored to defaults: {{ whpg_cleanup_restore_defaults }}"
      - "Packages removed: {{ whpg_cleanup_remove_packages | default(false) }}"
      - "NOTE: A reboot is recommended for all changes to take effect"
  when: whpg_cleanup_mode | bool
