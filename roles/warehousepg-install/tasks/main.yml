---
# WarehousePG Installation Tasks

- name: Include user management tasks
  include_tasks: user_management.yml
  tags: [user]

- name: Include /etc/hosts configuration
  include_tasks: configure_hosts.yml
  tags: [hosts]

- name: Install EPEL repository
  become: yes
  dnf:
    name: "https://dl.fedoraproject.org/pub/epel/epel-release-latest-9.noarch.rpm"
    state: present
    disable_gpg_check: yes

- name: Enable CRB (CodeReady Builder) repository
  become: yes
  command: dnf config-manager --set-enabled crb
  changed_when: false
  failed_when: false

- name: Debug EDB token value
  debug:
    msg: "EDB token defined: {{ edb_subscription_token is defined }}, Value length: {{ edb_subscription_token | default('') | length }}"
  tags: [install, packages]

- name: Validate EDB subscription token is provided
  fail:
    msg: "EDB subscription token is required. Please set edb_subscription_token variable."
  when: 
    - (edb_subscription_token is not defined) or (edb_subscription_token | default('') | length == 0)
    - "'init' not in ansible_run_tags or 'install' in ansible_run_tags or 'packages' in ansible_run_tags"
  tags: [install, packages]

- name: Setup EDB repository
  become: yes
  shell: |
    export EDB_SUBSCRIPTION_TOKEN="{{ edb_subscription_token }}"
    curl -1sSLf "https://downloads.enterprisedb.com/$EDB_SUBSCRIPTION_TOKEN/gpsupp/setup.rpm.sh" | bash
  args:
    executable: /bin/bash
    creates: /etc/yum.repos.d/enterprisedb-gpsupp.repo

- name: Clean DNF cache
  become: yes
  command: dnf clean all
  changed_when: false

- name: Install WarehousePG packages
  become: yes
  dnf:
    name: "{{ whpg_packages }}"
    state: present
    update_cache: yes
  register: package_install
  failed_when: false

- name: Display package installation result
  debug:
    msg: 
      - "Installation: {{ 'SUCCESS' if package_install.rc == 0 else 'FAILED (RC: ' + (package_install.rc | string) + ')' }}"
      - "{{ 'Changed: ' + (package_install.changed | string) if package_install.rc == 0 else 'Error: ' + (package_install.msg | default('Unknown error')) }}"
  when: package_install is defined

- name: Verify packages are actually installed
  shell: rpm -q {{ item }}
  loop: "{{ whpg_packages }}"
  register: rpm_verify
  failed_when: rpm_verify.rc != 0
  changed_when: false

- name: Check if symlink was created by package
  stat:
    path: /usr/local/greenplum-db
  register: symlink_check

- name: Display symlink status
  debug:
    msg: "Symlink /usr/local/greenplum-db: {{ 'EXISTS' if symlink_check.stat.exists else 'NOT CREATED - Package installation issue!' }}"

- name: Verify postgres binary exists
  stat:
    path: /usr/local/greenplum-db/bin/postgres
  register: postgres_binary
  when: symlink_check.stat.exists

- name: Assert package installation successful
  assert:
    that:
      - package_install.rc == 0
      - symlink_check.stat.exists
      - postgres_binary.stat.exists | default(false)
    fail_msg: |
      Package installation failed!
      - Installation return code: {{ package_install.rc | default('unknown') }}
      - Symlink exists: {{ symlink_check.stat.exists }}
      - Binary exists: {{ postgres_binary.stat.exists | default(false) }}
      Check the package installation output above for dependency errors.
    success_msg: "WarehousePG packages installed successfully"

- name: Verify WarehousePG version
  command: "{{ whpg_install_path }}/bin/postgres --version"
  register: whpg_version_check
  changed_when: false

- name: Display WarehousePG version
  debug:
    msg: "{{ whpg_version_check.stdout }}"

- name: Include passwordless SSH configuration
  include_tasks: passwordless_ssh.yml
  tags: [ssh]
