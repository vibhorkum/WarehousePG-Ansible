---
# Passwordless SSH Configuration Tasks
# Based on: https://warehouse-pg.io/docs/7x/install_guide/install_whpg.html
#
# This configures passwordless SSH for hosts in the current play (same site).
# For cross-site replication, use replication aliases defined in /etc/hosts.
# Cross-site SSH setup should be done during DR configuration.

# Determine which hosts to configure based on current play hosts
- name: Determine target hosts for SSH configuration
  set_fact:
    ssh_target_hosts: "{{ ansible_play_hosts_all }}"
  run_once: true

- name: Create .ssh directory for gpadmin
  become: yes
  file:
    path: "{{ whpg_gpadmin_home }}/.ssh"
    state: directory
    owner: "{{ whpg_gpadmin_user }}"
    group: "{{ whpg_gpadmin_user }}"
    mode: '0700'

- name: Generate SSH key for gpadmin if it doesn't exist
  become: yes
  become_user: "{{ whpg_gpadmin_user }}"
  openssh_keypair:
    path: "{{ whpg_gpadmin_home }}/.ssh/id_rsa"
    type: rsa
    size: 4096
    state: present
    force: no

- name: Set correct permissions on SSH private key
  become: yes
  file:
    path: "{{ whpg_gpadmin_home }}/.ssh/id_rsa"
    owner: "{{ whpg_gpadmin_user }}"
    group: "{{ whpg_gpadmin_user }}"
    mode: '0600'

- name: Set correct SELinux context on SSH directory
  become: yes
  command: restorecon -Rv "{{ whpg_gpadmin_home }}/.ssh"
  when: ansible_facts.selinux.status == "enabled"
  changed_when: false

- name: Add SSH client configuration for gpadmin
  become: yes
  become_user: "{{ whpg_gpadmin_user }}"
  blockinfile:
    path: "{{ whpg_gpadmin_home }}/.ssh/config"
    create: yes
    mode: '0600'
    block: |
      Host *
        StrictHostKeyChecking no
        UserKnownHostsFile /dev/null
        PubkeyAcceptedAlgorithms +rsa-sha2-512,rsa-sha2-256
        IdentityFile ~/.ssh/id_rsa

- name: Fetch SSH public key from each host
  become: yes
  slurp:
    src: "{{ whpg_gpadmin_home }}/.ssh/id_rsa.pub"
  register: local_pubkey

- name: Distribute all SSH public keys to all hosts
  become: yes
  authorized_key:
    user: "{{ whpg_gpadmin_user }}"
    state: present
    key: "{{ hostvars[item]['local_pubkey']['content'] | b64decode }}"
    exclusive: no
  loop: "{{ ssh_target_hosts }}"
  when: hostvars[item]['local_pubkey'] is defined

- name: Set correct permissions on authorized_keys
  become: yes
  file:
    path: "{{ whpg_gpadmin_home }}/.ssh/authorized_keys"
    owner: "{{ whpg_gpadmin_user }}"
    group: "{{ whpg_gpadmin_user }}"
    mode: '0600'

- name: Restore SELinux contexts after key distribution
  become: yes
  command: restorecon -Rv "{{ whpg_gpadmin_home }}/.ssh"
  when: ansible_facts.selinux.status == "enabled"
  changed_when: false

- name: Test passwordless SSH to localhost
  become: yes
  become_user: "{{ whpg_gpadmin_user }}"
  command: ssh -o BatchMode=yes localhost hostname
  register: ssh_test_local
  changed_when: false
  ignore_errors: yes

- name: Test passwordless SSH to all cluster hosts
  become: yes
  become_user: "{{ whpg_gpadmin_user }}"
  command: ssh -o BatchMode=yes {{ hostvars[item].hostname | default(item) }} hostname
  loop: "{{ ssh_target_hosts }}"
  register: ssh_test_all
  changed_when: false
  ignore_errors: yes
  when: ssh_target_hosts | length > 1

- name: Display SSH test results
  debug:
    msg: |
      Localhost SSH: {{ 'PASSED' if ssh_test_local.rc == 0 else 'FAILED - ' + ssh_test_local.stderr | default('unknown error') }}
      {% if ssh_test_all is defined and ssh_test_all.results is defined %}
      Cross-host SSH: {{ 'PASSED' if ssh_test_all.results | selectattr('rc', 'defined') | selectattr('rc', 'ne', 0) | list | length == 0 else 'FAILED' }}
      {% endif %}

- name: Fail if SSH tests failed
  fail:
    msg: "Passwordless SSH configuration failed. Check the errors above."
  when: ssh_test_local.rc != 0 or (ssh_test_all is defined and ssh_test_all.results | selectattr('rc', 'defined') | selectattr('rc', 'ne', 0) | list | length > 0)
