---
# Cleanup/Uninstall Tasks for WarehousePG Installation

- name: Stop WarehousePG cluster if running
  become: yes
  become_user: "{{ whpg_gpadmin_user }}"
  shell: |
    source {{ whpg_install_path }}/greenplum_path.sh || true
    gpstop -a -M fast || true
  args:
    executable: /bin/bash
  changed_when: false
  ignore_errors: yes
  when: whpg_cleanup_mode | bool

- name: Remove WarehousePG packages
  become: yes
  dnf:
    name: "{{ whpg_packages }}"
    state: absent
  when: 
    - whpg_cleanup_mode | bool
    - whpg_cleanup_remove_packages | bool

- name: Remove all WarehousePG related RPMs
  become: yes
  shell: |
    rpm -qa | grep -i warehouse | xargs -r dnf remove -y
    rpm -qa | grep -i whpg | xargs -r dnf remove -y
    rpm -qa | grep -i greenplum | xargs -r dnf remove -y
  args:
    executable: /bin/bash
  changed_when: true
  when: 
    - whpg_cleanup_mode | bool
    - whpg_cleanup_remove_packages | bool
  ignore_errors: yes

- name: Clean DNF cache
  become: yes
  command: dnf clean all
  changed_when: true
  when: 
    - whpg_cleanup_mode | bool
    - whpg_cleanup_remove_packages | bool

- name: Remove WarehousePG installation directories
  become: yes
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ whpg_install_path }}"
    - /usr/local/greenplum-db
    - /usr/local/greenplum-db-*
  when: 
    - whpg_cleanup_mode | bool
    - whpg_cleanup_remove_packages | bool

- name: Remove EDB repository configuration
  become: yes
  file:
    path: /etc/yum.repos.d/enterprisedb-gpsupp.repo
    state: absent
  when: 
    - whpg_cleanup_mode | bool
    - whpg_cleanup_remove_packages | bool

- name: Remove EDB GPG keys
  become: yes
  file:
    path: /etc/pki/rpm-gpg/edb-gpg-key
    state: absent
  when: 
    - whpg_cleanup_mode | bool
    - whpg_cleanup_remove_packages | bool

- name: Restore /etc/hosts from backup if it exists
  become: yes
  copy:
    src: /etc/hosts.whpg_backup
    dest: /etc/hosts
    remote_src: yes
    owner: root
    group: root
    mode: '0644'
  when:
    - whpg_cleanup_mode | bool
  ignore_errors: yes

- name: Remove /etc/hosts backup file
  become: yes
  file:
    path: /etc/hosts.whpg_backup
    state: absent
  when:
    - whpg_cleanup_mode | bool

- name: Remove cluster host entries from /etc/hosts if no backup exists
  become: yes
  lineinfile:
    path: /etc/hosts
    regexp: "{{ hostvars[item].hostname | default(item) }}"
    state: absent
  loop: "{{ groups['whpg_primary_site'] | default([]) + groups['whpg_dr_site'] | default([]) }}"
  when: whpg_cleanup_mode | bool

- name: Remove gpadmin SSH keys and config
  become: yes
  file:
    path: "{{ whpg_gpadmin_home }}/.ssh"
    state: absent
  when: 
    - whpg_cleanup_mode | bool
    - whpg_cleanup_remove_user | bool

- name: Remove gpadmin from wheel group
  become: yes
  user:
    name: "{{ whpg_gpadmin_user }}"
    groups: wheel
    append: no
  when: 
    - whpg_cleanup_mode | bool
    - whpg_cleanup_remove_user | bool
  ignore_errors: yes

- name: Remove gpadmin user
  become: yes
  user:
    name: "{{ whpg_gpadmin_user }}"
    state: absent
    remove: yes
  when: 
    - whpg_cleanup_mode | bool
    - whpg_cleanup_remove_user | bool

- name: Remove gpadmin group
  become: yes
  group:
    name: "{{ whpg_gpadmin_user }}"
    state: absent
  when: 
    - whpg_cleanup_mode | bool
    - whpg_cleanup_remove_user | bool

- name: Display cleanup completion message
  debug:
    msg:
      - "WarehousePG installation cleanup completed"
      - "Packages removed: {{ whpg_cleanup_remove_packages }}"
      - "User removed: {{ whpg_cleanup_remove_user }}"
      - "Configuration files and /etc/hosts restored from backup if available"
  when: whpg_cleanup_mode | bool
