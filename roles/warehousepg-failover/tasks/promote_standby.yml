---
# Phase 1: Promote DR Standby Coordinator to Primary
#
# This is the ONLY manual step required for DR failover.
# Once the coordinator is promoted, FTS will automatically handle segment failover.

- name: Get DR coordinator details
  set_fact:
    dr_coordinator_host: "{{ groups['whpg_dr_coordinator'][0] }}"
  run_once: true

- name: Check if DR standby coordinator data directory exists
  become: yes
  become_user: gpadmin
  stat:
    path: "{{ whpg_coordinator_data_directory }}/postgresql.conf"
  delegate_to: "{{ dr_coordinator_host }}"
  register: dr_data_dir
  run_once: true

- name: Fail if DR data directory does not exist
  fail:
    msg: |
      DR coordinator data directory does not exist: {{ whpg_coordinator_data_directory }}
      Please run dr_setup.yml first to initialize the DR site.
  when: not dr_data_dir.stat.exists
  run_once: true

- name: Check if DR is currently in standby mode
  become: yes
  become_user: gpadmin
  stat:
    path: "{{ whpg_coordinator_data_directory }}/standby.signal"
  delegate_to: "{{ dr_coordinator_host }}"
  register: standby_signal
  run_once: true

- name: Check if DR coordinator is already running as primary
  become: yes
  become_user: gpadmin
  shell: |
    source {{ whpg_base_dir }}/greenplum_path.sh
    export COORDINATOR_DATA_DIRECTORY={{ whpg_coordinator_data_directory }}
    # Check if postgres is running and accepting connections
    if pg_isready -h localhost -p {{ whpg_coordinator_port }} -t 5 2>/dev/null; then
      # Check if it's a primary (no standby.signal and can write)
      if psql -d template1 -t -c "SELECT pg_is_in_recovery();" 2>/dev/null | grep -q 'f'; then
        echo "ALREADY_PRIMARY"
      else
        echo "STANDBY_RUNNING"
      fi
    else
      echo "NOT_RUNNING"
    fi
  delegate_to: "{{ dr_coordinator_host }}"
  register: dr_status
  changed_when: false
  failed_when: false
  run_once: true

- name: Display current DR coordinator status
  debug:
    msg:
      - "DR Coordinator Status: {{ dr_status.stdout | trim }}"
      - "Standby signal exists: {{ standby_signal.stat.exists | default(false) }}"
  run_once: true

- name: Skip promotion if already primary
  debug:
    msg: "DR coordinator is already running as primary. Skipping promotion."
  when: dr_status.stdout | trim == 'ALREADY_PRIMARY'
  run_once: true

# ============================================================
# Promote Standby Coordinator using gpactivatestandby
# ============================================================
- name: Promote DR standby coordinator to primary
  become: yes
  become_user: gpadmin
  shell: |
    source {{ whpg_base_dir }}/greenplum_path.sh
    export COORDINATOR_DATA_DIRECTORY={{ whpg_coordinator_data_directory }}
    export PGPORT={{ whpg_coordinator_port }}
    
    echo "=== Promoting DR Standby Coordinator to Primary ==="
    echo ""
    echo "Running: gpactivatestandby -d {{ whpg_coordinator_data_directory }} -a -f"
    echo ""
    
    # The -f flag forces activation even if the standby is not running
    # The -a flag answers yes to all prompts
    gpactivatestandby -d {{ whpg_coordinator_data_directory }} -a -f
    
    EXIT_CODE=$?
    
    if [ $EXIT_CODE -eq 0 ]; then
      echo ""
      echo "=== Standby coordinator promoted successfully ==="
      echo "This coordinator is now the PRIMARY."
    else
      echo ""
      echo "=== gpactivatestandby returned exit code: $EXIT_CODE ==="
    fi
    
    exit $EXIT_CODE
  delegate_to: "{{ dr_coordinator_host }}"
  register: promote_result
  when: dr_status.stdout | trim != 'ALREADY_PRIMARY'
  run_once: true

- name: Display promotion result
  debug:
    msg: "{{ promote_result.stdout_lines | default(['Promotion skipped - already primary']) }}"
  run_once: true

# ============================================================
# Verify coordinator is now primary
# ============================================================
- name: Wait for promoted coordinator to be ready
  become: yes
  become_user: gpadmin
  shell: |
    source {{ whpg_base_dir }}/greenplum_path.sh
    pg_isready -h localhost -p {{ whpg_coordinator_port }} -t 30
  delegate_to: "{{ dr_coordinator_host }}"
  register: coord_ready
  retries: 6
  delay: 10
  until: coord_ready.rc == 0
  run_once: true
  failed_when: false

- name: Verify coordinator is no longer in recovery mode
  become: yes
  become_user: gpadmin
  shell: |
    source {{ whpg_base_dir }}/greenplum_path.sh
    export COORDINATOR_DATA_DIRECTORY={{ whpg_coordinator_data_directory }}
    
    IN_RECOVERY=$(psql -d template1 -t -c "SELECT pg_is_in_recovery();" | tr -d ' ')
    
    if [ "$IN_RECOVERY" = "f" ]; then
      echo "SUCCESS: Coordinator is running as PRIMARY (not in recovery)"
      exit 0
    else
      echo "ERROR: Coordinator is still in recovery mode"
      exit 1
    fi
  delegate_to: "{{ dr_coordinator_host }}"
  register: recovery_check
  run_once: true

- name: Display coordinator verification
  debug:
    msg: "{{ recovery_check.stdout }}"
  run_once: true
