---
# Stop primary site (planned failover only)
# This is optional - only needed if primary is accessible for graceful shutdown

- name: Get primary hosts
  set_fact:
    primary_coordinator_host: "{{ groups['whpg_primary_coordinator'][0] }}"
    primary_segment_hosts: "{{ groups['whpg_primary_segments'] | default([]) }}"
  run_once: true

- name: Check connectivity to primary coordinator
  shell: |
    timeout 5 ssh -o BatchMode=yes -o ConnectTimeout=3 -o StrictHostKeyChecking=no {{ hostvars[primary_coordinator_host].ansible_host }} "echo reachable" 2>/dev/null || echo "unreachable"
  register: primary_coord_check
  delegate_to: localhost
  become: no
  changed_when: false
  failed_when: false
  run_once: true

- name: Set primary accessibility status
  set_fact:
    primary_is_accessible: "{{ 'reachable' in (primary_coord_check.stdout | default('')) }}"
  run_once: true

- name: Display primary site accessibility
  debug:
    msg:
      - "Primary coordinator accessible: {{ primary_is_accessible }}"
      - "Failover mode: {{ whpg_failover_mode }}"
  run_once: true

# ============================================================
# Graceful shutdown of primary (if accessible)
# ============================================================
- name: Gracefully stop primary cluster
  become: yes
  become_user: gpadmin
  shell: |
    source {{ whpg_base_dir }}/greenplum_path.sh
    export COORDINATOR_DATA_DIRECTORY={{ whpg_coordinator_data_directory }}
    
    echo "=== Stopping primary cluster gracefully ==="
    
    # Check if cluster is running
    if gpstate -Q 2>/dev/null | grep -qi "running"; then
      echo "Cluster is running, stopping with gpstop..."
      gpstop -M fast -a
      echo "Primary cluster stopped"
    else
      echo "Primary cluster is not running or not responding"
    fi
  delegate_to: "{{ primary_coordinator_host }}"
  register: stop_primary
  when: primary_is_accessible
  run_once: true
  ignore_errors: yes

- name: Display stop result
  debug:
    msg: "{{ stop_primary.stdout_lines | default(['Primary cluster stop skipped - not accessible']) }}"
  run_once: true

- name: Wait for primary to fully stop
  pause:
    seconds: 10
  when:
    - primary_is_accessible
    - stop_primary is changed
  run_once: true

# ============================================================
# Handle unreachable primary scenario
# ============================================================
- name: Display unreachable primary information
  debug:
    msg:
      - "========================================="
      - "Primary site is NOT accessible"
      - "========================================="
      - "This is expected in disaster recovery scenarios."
      - "Proceeding with DR promotion."
      - ""
      - "After DR site is operational:"
      - "  1. When primary site recovers, DO NOT start it"
      - "  2. Use gprecoverseg to rebuild it as mirror"
  when: not primary_is_accessible
  run_once: true
