---
# WarehousePG Failback Playbook
#
# This playbook performs failback from DR site back to primary site.
# Use this after a failover event when the primary site is recovered and ready.
#
# Usage:
#   # Standard failback (rebuilds primary as new standby, then switches)
#   ansible-playbook -i inventory.yml failback.yml
#
#   # Force failback (skip safety checks)
#   ansible-playbook -i inventory.yml failback.yml -e "whpg_failback_force=true"
#
#   # Skip primary rebuild (if primary is already in sync)
#   ansible-playbook -i inventory.yml failback.yml -e "whpg_failback_skip_rebuild=true"
#
# Prerequisites:
#   - Successful failover was performed (DR site is currently primary)
#   - Primary site is recovered and accessible
#   - Network connectivity between sites is restored

# Phase 1: Pre-failback checks
- name: WarehousePG Failback - Pre-checks
  hosts: whpg_primary_coordinator
  become: yes
  gather_facts: yes
  
  vars:
    whpg_failback_force: false
    whpg_failback_skip_checks: false
  
  tasks:
    - name: Display failback warning
      debug:
        msg:
          - "╔══════════════════════════════════════════════════════════════╗"
          - "║              WARNING: FAILBACK OPERATION                     ║"
          - "╠══════════════════════════════════════════════════════════════╣"
          - "║ This will restore the PRIMARY site as the active cluster.   ║"
          - "║                                                              ║"
          - "║ Current Primary: DR Site                                     ║"
          - "║ Target Primary:  Original Primary Site                       ║"
          - "║                                                              ║"
          - "║ This operation will:                                         ║"
          - "║ 1. Rebuild old primary as standby from current DR primary    ║"
          - "║ 2. Sync data from DR to rebuilt primary                      ║"
          - "║ 3. Promote rebuilt primary back to primary role              ║"
          - "║ 4. Demote DR site back to standby role                       ║"
          - "╚══════════════════════════════════════════════════════════════╝"
      tags: always

    - name: Pause for confirmation
      pause:
        prompt: "Press Enter to continue with failback or Ctrl+C to abort"
      when: not (whpg_failback_force | default(false))
      tags: always

    - name: Check primary site accessibility
      ping:
      register: primary_ping
      tags: [checks]

    - name: Verify primary site is accessible
      assert:
        that:
          - primary_ping is succeeded
        fail_msg: "Primary site is not accessible. Cannot proceed with failback."
        success_msg: "Primary site is accessible."
      tags: [checks]

# Phase 2: Check current DR site status
- name: WarehousePG Failback - Verify DR Site Status
  hosts: whpg_dr_coordinator
  become: yes
  gather_facts: yes
  
  vars:
    whpg_base_dir: "/usr/local/greenplum-db-{{ whpg_version | default('7.3.0') }}-WHPG"
    whpg_coordinator_data_directory: /data/coordinator/gpseg-1
  
  tasks:
    - name: Check if DR site is running as primary
      become_user: gpadmin
      shell: |
        source {{ whpg_base_dir }}/greenplum_path.sh
        export COORDINATOR_DATA_DIRECTORY={{ whpg_coordinator_data_directory }}
        psql -d template1 -t -c "SELECT 1;"
      register: dr_running
      changed_when: false
      failed_when: false
      tags: [checks]

    - name: Check if DR coordinator data directory exists
      become_user: gpadmin
      stat:
        path: "{{ whpg_coordinator_data_directory }}/postgresql.conf"
      register: dr_data_exists
      tags: [checks]

    - name: Check if DR is still in standby mode
      become_user: gpadmin
      stat:
        path: "{{ whpg_coordinator_data_directory }}/standby.signal"
      register: dr_standby_signal
      tags: [checks]

    - name: Display DR site diagnostic information
      debug:
        msg:
          - "DR Site Status:"
          - "  - Data directory exists: {{ dr_data_exists.stat.exists | default(false) }}"
          - "  - Standby signal present: {{ dr_standby_signal.stat.exists | default(false) }}"
          - "  - Database responding: {{ dr_running.rc == 0 }}"
          - ""
          - "{% if dr_standby_signal.stat.exists | default(false) %}ISSUE: DR is still in STANDBY mode. You need to run FAILOVER first!{% endif %}"
          - "{% if not dr_data_exists.stat.exists | default(false) %}ISSUE: DR data directory not found. DR setup may not be complete.{% endif %}"
      when: dr_running.rc != 0
      tags: [checks]

    - name: Fail if DR is still in standby mode
      fail:
        msg: |
          DR site is still in STANDBY mode (standby.signal exists).
          
          You need to run FAILOVER first before FAILBACK:
            ansible-playbook -i inventory.yml failover.yml
          
          Failback is only used to return from DR site BACK to primary site
          AFTER a failover has already been performed.
      when: 
        - dr_standby_signal.stat.exists | default(false)
        - not (whpg_failback_force | default(false))
      tags: [checks]

    - name: Attempt to start DR cluster if not running
      become_user: gpadmin
      shell: |
        source {{ whpg_base_dir }}/greenplum_path.sh
        export COORDINATOR_DATA_DIRECTORY={{ whpg_coordinator_data_directory }}
        echo "Attempting to start DR cluster..."
        gpstart -a
      register: dr_start_attempt
      when: 
        - dr_running.rc != 0
        - dr_data_exists.stat.exists | default(false)
        - not (dr_standby_signal.stat.exists | default(false))
        - whpg_failback_force | default(false)
      failed_when: false
      tags: [checks]

    - name: Re-check DR site after start attempt
      become_user: gpadmin
      shell: |
        source {{ whpg_base_dir }}/greenplum_path.sh
        export COORDINATOR_DATA_DIRECTORY={{ whpg_coordinator_data_directory }}
        psql -d template1 -t -c "SELECT 1;"
      register: dr_running_retry
      when: dr_start_attempt is changed
      changed_when: false
      failed_when: false
      tags: [checks]

    - name: Update DR running status
      set_fact:
        dr_running: "{{ dr_running_retry }}"
      when: dr_running_retry is defined and dr_running_retry.rc is defined
      tags: [checks]

    - name: Verify DR site is operational
      assert:
        that:
          - dr_running.rc == 0
        fail_msg: |
          DR site is not running. Cannot proceed with failback.
          
          Possible causes:
          1. Failover was never performed (DR is still standby) - run failover.yml first
          2. DR cluster crashed and needs manual recovery
          3. DR data directory is missing or corrupted
          
          To force failback anyway (skip this check):
            ansible-playbook -i inventory.yml failback.yml -e "whpg_failback_force=true"
        success_msg: "DR site is operational as current primary."
      when: not (whpg_failback_force | default(false))
      tags: [checks]

    - name: Get current cluster status
      become_user: gpadmin
      shell: |
        source {{ whpg_base_dir }}/greenplum_path.sh
        export COORDINATOR_DATA_DIRECTORY={{ whpg_coordinator_data_directory }}
        gpstate -s
      register: cluster_status
      changed_when: false
      failed_when: false
      tags: [checks]

    - name: Display current cluster status
      debug:
        msg: "{{ cluster_status.stdout_lines }}"
      tags: [checks]

# Phase 3: Stop cluster on DR site
- name: WarehousePG Failback - Stop DR Cluster
  hosts: whpg_dr_coordinator
  become: yes
  gather_facts: yes
  
  vars:
    whpg_base_dir: "/usr/local/greenplum-db-{{ whpg_version | default('7.3.0') }}-WHPG"
    whpg_coordinator_data_directory: /data/coordinator/gpseg-1
  
  tasks:
    - name: Stop DR cluster gracefully
      become_user: gpadmin
      shell: |
        source {{ whpg_base_dir }}/greenplum_path.sh
        export COORDINATOR_DATA_DIRECTORY={{ whpg_coordinator_data_directory }}
        gpstop -a -M fast
      register: stop_dr
      failed_when: false
      tags: [failback]

    - name: Display stop result
      debug:
        msg: "{{ stop_dr.stdout_lines if stop_dr.stdout_lines is defined else 'Cluster stop attempted' }}"
      tags: [failback]

# Phase 4: Rebuild primary site from DR site
- name: WarehousePG Failback - Rebuild Primary Site
  hosts: whpg_primary_coordinator
  become: yes
  gather_facts: yes
  
  vars:
    whpg_base_dir: "/usr/local/greenplum-db-{{ whpg_version | default('7.3.0') }}-WHPG"
    whpg_coordinator_data_directory: /data/coordinator/gpseg-1
    whpg_failback_skip_rebuild: false
  
  tasks:
    - name: Skip rebuild if requested
      debug:
        msg: "Skipping primary rebuild as requested"
      when: whpg_failback_skip_rebuild | default(false)
      tags: [failback]

    - name: Clean up old primary coordinator data
      become_user: gpadmin
      shell: |
        # Stop any running postgres processes
        pkill -9 -u gpadmin postgres || true
        # Remove old data directory
        rm -rf {{ whpg_coordinator_data_directory }}
      when: not (whpg_failback_skip_rebuild | default(false))
      tags: [failback]

    - name: Rebuild primary coordinator from DR using pg_basebackup
      become_user: gpadmin
      shell: |
        source {{ whpg_base_dir }}/greenplum_path.sh
        
        # Get DR coordinator hostname
        DR_COORD="{{ groups['whpg_dr_coordinator'][0] }}"
        DR_HOST="{{ hostvars[groups['whpg_dr_coordinator'][0]].private_ip | default(hostvars[groups['whpg_dr_coordinator'][0]].ansible_host) }}"
        
        echo "Rebuilding from DR coordinator: $DR_HOST"
        
        # Create base backup from DR site
        pg_basebackup -h $DR_HOST -p 5432 -D {{ whpg_coordinator_data_directory }} \
          -X stream -R -P -v -c fast
      register: rebuild_primary
      when: not (whpg_failback_skip_rebuild | default(false))
      tags: [failback]

    - name: Display rebuild result
      debug:
        msg: "{{ rebuild_primary.stdout_lines if rebuild_primary.stdout_lines is defined else 'Rebuild skipped' }}"
      when: rebuild_primary is defined
      tags: [failback]

# Phase 5: Start primary and promote
- name: WarehousePG Failback - Promote Primary Site
  hosts: whpg_primary_coordinator
  become: yes
  gather_facts: yes
  
  vars:
    whpg_base_dir: "/usr/local/greenplum-db-{{ whpg_version | default('7.3.0') }}-WHPG"
    whpg_coordinator_data_directory: /data/coordinator/gpseg-1
  
  tasks:
    - name: Remove standby.signal to allow primary mode
      become_user: gpadmin
      file:
        path: "{{ whpg_coordinator_data_directory }}/standby.signal"
        state: absent
      tags: [failback]

    - name: Start primary cluster
      become_user: gpadmin
      shell: |
        source {{ whpg_base_dir }}/greenplum_path.sh
        export COORDINATOR_DATA_DIRECTORY={{ whpg_coordinator_data_directory }}
        gpstart -a
      register: start_primary
      failed_when: false
      tags: [failback]

    - name: Display start result
      debug:
        msg: "{{ start_primary.stdout_lines }}"
      tags: [failback]

# Phase 6: Reconfigure DR site as standby
- name: WarehousePG Failback - Configure DR as Standby
  hosts: whpg_dr_coordinator
  become: yes
  gather_facts: yes
  
  vars:
    whpg_base_dir: "/usr/local/greenplum-db-{{ whpg_version | default('7.3.0') }}-WHPG"
    whpg_coordinator_data_directory: /data/coordinator/gpseg-1
  
  tasks:
    - name: Clean up DR coordinator data
      become_user: gpadmin
      shell: |
        # Stop any running postgres processes
        pkill -9 -u gpadmin postgres || true
        # Remove old data directory
        rm -rf {{ whpg_coordinator_data_directory }}
      tags: [failback]

    - name: Rebuild DR as standby from primary
      become_user: gpadmin
      shell: |
        source {{ whpg_base_dir }}/greenplum_path.sh
        
        PRIMARY_HOST="{{ hostvars[groups['whpg_primary_coordinator'][0]].private_ip | default(hostvars[groups['whpg_primary_coordinator'][0]].ansible_host) }}"
        
        echo "Rebuilding DR standby from primary: $PRIMARY_HOST"
        
        pg_basebackup -h $PRIMARY_HOST -p 5432 -D {{ whpg_coordinator_data_directory }} \
          -X stream -R -P -v -c fast
      register: rebuild_dr
      tags: [failback]

    - name: Start DR as standby
      become_user: gpadmin
      shell: |
        source {{ whpg_base_dir }}/greenplum_path.sh
        pg_ctl -D {{ whpg_coordinator_data_directory }} start -l {{ whpg_coordinator_data_directory }}/log/startup.log
      register: start_dr_standby
      failed_when: false
      tags: [failback]

# Phase 7: Add standby back to cluster
- name: WarehousePG Failback - Register Standby
  hosts: whpg_primary_coordinator
  become: yes
  gather_facts: yes
  
  vars:
    whpg_base_dir: "/usr/local/greenplum-db-{{ whpg_version | default('7.3.0') }}-WHPG"
    whpg_coordinator_data_directory: /data/coordinator/gpseg-1
  
  tasks:
    - name: Add DR coordinator as standby
      become_user: gpadmin
      shell: |
        source {{ whpg_base_dir }}/greenplum_path.sh
        export COORDINATOR_DATA_DIRECTORY={{ whpg_coordinator_data_directory }}
        
        DR_HOST="{{ hostvars[groups['whpg_dr_coordinator'][0]].hostname | default(groups['whpg_dr_coordinator'][0]) }}"
        
        # Check if standby already registered
        STANDBY_EXISTS=$(psql -d template1 -t -c "SELECT count(*) FROM gp_segment_configuration WHERE content = -1 AND role = 'm';")
        
        if [ "$STANDBY_EXISTS" -eq "0" ]; then
          echo "Adding standby coordinator: $DR_HOST"
          gpinitstandby -s $DR_HOST -a
        else
          echo "Standby coordinator already configured"
        fi
      register: add_standby
      failed_when: false
      tags: [failback]

    - name: Display standby registration result
      debug:
        msg: "{{ add_standby.stdout_lines }}"
      tags: [failback]

# Phase 8: Verify failback
- name: WarehousePG Failback - Verification
  hosts: whpg_primary_coordinator
  become: yes
  gather_facts: yes
  
  vars:
    whpg_base_dir: "/usr/local/greenplum-db-{{ whpg_version | default('7.3.0') }}-WHPG"
    whpg_coordinator_data_directory: /data/coordinator/gpseg-1
  
  tasks:
    - name: Check cluster status
      become_user: gpadmin
      shell: |
        source {{ whpg_base_dir }}/greenplum_path.sh
        export COORDINATOR_DATA_DIRECTORY={{ whpg_coordinator_data_directory }}
        gpstate -s
      register: final_status
      changed_when: false
      tags: [verify]

    - name: Check replication status
      become_user: gpadmin
      shell: |
        source {{ whpg_base_dir }}/greenplum_path.sh
        export COORDINATOR_DATA_DIRECTORY={{ whpg_coordinator_data_directory }}
        psql -d template1 -c "SELECT * FROM pg_stat_replication;"
      register: replication_status
      changed_when: false
      failed_when: false
      tags: [verify]

    - name: Display failback completion summary
      debug:
        msg:
          - "╔══════════════════════════════════════════════════════════════╗"
          - "║              FAILBACK COMPLETE                               ║"
          - "╠══════════════════════════════════════════════════════════════╣"
          - "║ Primary Coordinator: {{ groups['whpg_primary_coordinator'][0] }}"
          - "║ Standby Coordinator: {{ groups['whpg_dr_coordinator'][0] }}"
          - "║                                                              ║"
          - "║ Next Steps:                                                  ║"
          - "║ 1. Verify application connectivity to primary site          ║"
          - "║ 2. Monitor replication lag: gpstate -f                       ║"
          - "║ 3. Recover segment mirrors if needed: gprecoverseg -a        ║"
          - "╚══════════════════════════════════════════════════════════════╝"
      tags: [verify]
