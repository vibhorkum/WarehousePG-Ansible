---
# Installation and Configuration Playbook: Step-by-Step WarehousePG Setup
# This playbook demonstrates the complete installation and configuration workflow
# with individual steps for better control
#
# Usage:
#   # Run all steps:
#   ansible-playbook -i inventory.yml install_and_config.yml
#
#   # Run specific steps:
#   ansible-playbook -i inventory.yml install_and_config.yml --tags os-config
#   ansible-playbook -i inventory.yml install_and_config.yml --tags install
#   ansible-playbook -i inventory.yml install_and_config.yml --tags storage
#   ansible-playbook -i inventory.yml install_and_config.yml --tags init

- name: Configure OS for WarehousePG - Primary Site
  hosts: whpg_primary_site
  become: yes
  vars:
    edb_subscription_token: "a42f0873c732be6edafe2e22849eb0ff"
  roles:
    - role: warehousepg-os-config
      tags: [os-config, config]

- name: Install WarehousePG - Primary Site
  hosts: whpg_primary_site
  become: yes
  vars:
    edb_subscription_token: "a42f0873c732be6edafe2e22849eb0ff"
  roles:
    - role: warehousepg-install
      tags: [install, packages]

- name: Create Storage Directories - Primary Site
  hosts: whpg_primary_site
  become: yes
  roles:
    - role: warehousepg-storage
      tags: [storage]

# Optional: DR Site Setup (only if using DR site mirrors)
- name: Configure OS for WarehousePG - DR Site
  hosts: whpg_dr_site
  become: yes
  vars:
    edb_subscription_token: "a42f0873c732be6edafe2e22849eb0ff"
  roles:
    - role: warehousepg-os-config
      tags: [os-config-dr, config]
      when: whpg_use_dr_site_mirrors | default(false)

- name: Install WarehousePG - DR Site
  hosts: whpg_dr_site
  become: yes
  vars:
    edb_subscription_token: "a42f0873c732be6edafe2e22849eb0ff"
  roles:
    - role: warehousepg-install
      tags: [install-dr, packages]
      when: whpg_use_dr_site_mirrors | default(false)

- name: Create Storage Directories - DR Site
  hosts: whpg_dr_site
  become: yes
  roles:
    - role: warehousepg-storage
      tags: [storage-dr]
      when: whpg_use_dr_site_mirrors | default(false)

# Initialize the WarehousePG Cluster
- name: Initialize WarehousePG Cluster
  hosts: whpg_primary_coordinator
  become: yes
  vars:
    # Cluster initialization variables
    # For single-disk setup, use subdirectories under /data
    whpg_coordinator_directory: "/data/coordinator"
    whpg_data_directories:
      - "/data/primary/seg1"
      - "/data/primary/seg2"
    
    whpg_enable_mirrors: false
    whpg_use_dr_site_mirrors: false
    
    whpg_mirror_data_directories:
      - "/data/mirror/seg1"
      - "/data/mirror/seg2"
    
    whpg_mirror_port_base: 7000
    whpg_mirror_mode: "spread"
    
    whpg_standby_coordinator_hostname: ""
    whpg_timezone: "US/Pacific"
  
  roles:
    - role: warehousepg-init
      tags: [init, cluster-init, initialization]

# Post-installation validation
- name: Validate Installation
  hosts: whpg_primary_coordinator
  become: yes
  become_user: gpadmin
  tags: [validate]
  
  tasks:
    - name: Check WarehousePG version
      ansible.builtin.command: psql --version
      register: psql_version
      changed_when: false

    - name: Display WarehousePG version
      ansible.builtin.debug:
        msg: "{{ psql_version.stdout }}"

    - name: Check cluster status
      ansible.builtin.shell: |
        source /usr/local/greenplum-db/greenplum_path.sh
        export COORDINATOR_DATA_DIRECTORY=/data/coordinator/gpseg-1
        gpstate -Q
      args:
        executable: /bin/bash
      register: cluster_status
      changed_when: false
      failed_when: false

    - name: Display cluster status
      ansible.builtin.debug:
        msg: "{{ cluster_status.stdout_lines }}"
      when: cluster_status.rc == 0

    - name: Get segment configuration
      ansible.builtin.shell: |
        source /usr/local/greenplum-db/greenplum_path.sh
        export COORDINATOR_DATA_DIRECTORY=/data/coordinator/gpseg-1
        psql -d gpadmin -c "SELECT content, role, preferred_role, mode, status, hostname FROM gp_segment_configuration ORDER BY content, role DESC;"
      args:
        executable: /bin/bash
      register: segment_config
      changed_when: false
      failed_when: false

    - name: Display segment configuration
      ansible.builtin.debug:
        msg: "{{ segment_config.stdout_lines }}"
      when: segment_config.rc == 0

    - name: Display installation complete message
      ansible.builtin.debug:
        msg:
          - "======================================================"
          - "WarehousePG Installation and Configuration Complete!"
          - "======================================================"
          - ""
          - "All steps completed successfully."
          - "Your WarehousePG cluster is ready to use."
          - ""
          - "======================================================"
